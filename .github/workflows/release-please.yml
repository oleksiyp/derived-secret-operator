name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          # Use manifest-based configuration
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

  # Build and publish releases when release-please creates a release
  publish-release:
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          cache: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push multi-arch Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ needs.release-please.outputs.tag_name }}
            ghcr.io/${{ github.repository }}:latest
          labels: |
            org.opencontainers.image.title=derived-secret-operator
            org.opencontainers.image.version=${{ needs.release-please.outputs.version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
          build-args: |
            VERSION=${{ needs.release-please.outputs.version }}
            COMMIT=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and publish Helm chart
        run: |
          # Login to Helm registry
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

          # Package the chart
          helm package charts/derived-secret-operator

          # Get the chart version
          CHART_VERSION=$(grep '^version:' charts/derived-secret-operator/Chart.yaml | awk '{print $2}')

          # Push to GHCR
          helm push derived-secret-operator-${CHART_VERSION}.tgz oci://ghcr.io/${{ github.repository_owner }}/charts

          echo "âœ… Published Helm chart: ghcr.io/${{ github.repository_owner }}/charts/derived-secret-operator:${CHART_VERSION}"

      - name: Generate installation YAML
        run: |
          make build-installer IMG=ghcr.io/${{ github.repository }}:${{ needs.release-please.outputs.tag_name }}

      - name: Upload installation YAML to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} \
            dist/install.yaml \
            --clobber

      - name: Update release notes with installation instructions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat >> /tmp/release-notes.md <<'EOF'

          ## Installation

          ### Using kubectl
          ```bash
          kubectl apply -f https://github.com/${{ github.repository }}/releases/download/${{ needs.release-please.outputs.tag_name }}/install.yaml
          ```

          ### Using Helm
          ```bash
          helm install derived-secret-operator \
            oci://ghcr.io/${{ github.repository_owner }}/charts/derived-secret-operator \
            --version $(grep '^version:' charts/derived-secret-operator/Chart.yaml | awk '{print $2}') \
            --namespace derived-secret-operator-system \
            --create-namespace
          ```

          ### Using Docker
          ```bash
          docker pull ghcr.io/${{ github.repository }}:${{ needs.release-please.outputs.tag_name }}
          ```

          ## Container Images
          - `ghcr.io/${{ github.repository }}:${{ needs.release-please.outputs.tag_name }}`
          - `ghcr.io/${{ github.repository }}:latest`

          **Architectures:** linux/amd64, linux/arm64
          EOF

          # Append to existing release notes
          EXISTING_NOTES=$(gh release view ${{ needs.release-please.outputs.tag_name }} --json body -q .body)
          echo "${EXISTING_NOTES}" > /tmp/full-notes.md
          cat /tmp/release-notes.md >> /tmp/full-notes.md
          gh release edit ${{ needs.release-please.outputs.tag_name }} --notes-file /tmp/full-notes.md
