name: CI

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          cache: true

      - name: Lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.6.1
          args: --timeout=5m

      - name: Test
        run: |
          make envtest
          export KUBEBUILDER_ASSETS=$(./bin/setup-envtest use -p path)
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out

      - name: Security scan
        uses: securego/gosec@v2.22.10
        with:
          args: ./...

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          cache: true

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          version: v0.20.0

      - name: Build and test
        run: |
          make docker-build IMG=derived-secret-operator:test
          kind load docker-image derived-secret-operator:test --name test-cluster
          make install
          make deploy IMG=derived-secret-operator:test
          kubectl wait --for=condition=available --timeout=300s deployment/derived-secret-operator-controller-manager -n derived-secret-operator-system
          kubectl apply -f config/samples/secrets_v1alpha1_masterpassword.yaml
          kubectl apply -f config/samples/secrets_v1alpha1_derivedsecret.yaml
          kubectl wait --for=condition=ready --timeout=60s masterpassword/default
          kubectl wait --for=condition=ready --timeout=60s derivedsecret -l app=test

  # Build and push snapshot artifacts on every main push
  snapshot-docker:
    name: Snapshot Docker Images
    runs-on: ubuntu-latest
    needs: [validate, e2e]
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:edge
            ghcr.io/${{ github.repository }}:sha-${{ steps.sha.outputs.short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  snapshot-helm:
    name: Snapshot Helm Chart
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.0

      - name: Lint chart
        run: helm lint charts/derived-secret-operator

      - name: Package snapshot chart
        run: |
          BASE_VERSION=$(grep '^version:' charts/derived-secret-operator/Chart.yaml | awk '{print $2}')
          SHORT_SHA=$(git rev-parse --short HEAD)
          SNAPSHOT_VERSION="${BASE_VERSION}-dev.${SHORT_SHA}"

          sed -i.bak "s/^version: .*/version: ${SNAPSHOT_VERSION}/" charts/derived-secret-operator/Chart.yaml
          sed -i.bak "s/^appVersion: .*/appVersion: sha-${SHORT_SHA}/" charts/derived-secret-operator/Chart.yaml

          helm package charts/derived-secret-operator
          mv charts/derived-secret-operator/Chart.yaml.bak charts/derived-secret-operator/Chart.yaml

          echo "SNAPSHOT_VERSION=${SNAPSHOT_VERSION}" >> $GITHUB_ENV

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push snapshot chart
        run: |
          helm push derived-secret-operator-${{ env.SNAPSHOT_VERSION }}.tgz oci://ghcr.io/${{ github.repository_owner }}/charts
          echo "ðŸ“¦ Snapshot published: oci://ghcr.io/${{ github.repository_owner }}/charts/derived-secret-operator:${{ env.SNAPSHOT_VERSION }}"
